<!-- å¤´éƒ¨å·¥å…·æ  -->
<div class="header-toolbar">
    <div class="toolbar-left">
        <h2>ğŸŒ³ è¡Œä¸ºæ ‘å¯è§†åŒ–ç¼–è¾‘å™¨ 
            <span v-if="currentFileName" class="current-file">- {{ currentFileName }}</span>
            <span v-if="hasUnsavedChanges" class="unsaved-indicator">â—</span>
        </h2>
        <div class="toolbar-buttons">
            <button class="tool-btn" @click="newBehaviorTree" title="æ–°å»ºè¡Œä¸ºæ ‘">
                <span>ğŸ“„</span> æ–°å»º
            </button>
            <button class="tool-btn" :class="{ 'has-changes': hasUnsavedChanges }" @click="saveBehaviorTree" :title="currentFilePath ? 'ä¿å­˜åˆ°: ' + currentFilePath : (currentFileName ? 'å¦å­˜ä¸º ' + currentFileName : 'ä¿å­˜è¡Œä¸ºæ ‘')">
                <span>ğŸ’¾</span> ä¿å­˜{{ hasUnsavedChanges ? ' *' : '' }}
            </button>
            <button class="tool-btn" @click="saveAsBehaviorTree" title="å¦å­˜ä¸ºæ–°æ–‡ä»¶">
                <span>ğŸ’¾</span> å¦å­˜ä¸º
            </button>
            <button class="tool-btn" @click="loadBehaviorTree" title="åŠ è½½è¡Œä¸ºæ ‘">
                <span>ğŸ“‚</span> åŠ è½½
            </button>
            <button class="tool-btn" @click="exportConfig" title="å¯¼å‡ºé…ç½®">
                <span>âš¡</span> å¯¼å‡ºé…ç½®
            </button>
        </div>
    </div>
    <div class="toolbar-right">
        <div class="install-status-container">
            <div class="install-status" :class="installStatusClass()">
                <div class="status-info">
                    <span class="status-icon">{{ isInstalled ? 'âœ…' : (isInstalling ? 'â³' : 'âŒ') }}</span>
                    <div class="status-text">
                        <span class="main-text">{{ installStatusText() }}</span>
                        <span v-if="version && isInstalled" class="version-text">ç‰ˆæœ¬ {{ version }}</span>
                    </div>
                </div>
                <button 
                    v-if="!isInstalled" 
                    @click="handleInstall" 
                    :disabled="isInstalling"
                    class="install-btn"
                    :class="{ 'installing': isInstalling }"
                >
                    <span class="btn-icon">{{ isInstalling ? 'â³' : 'ğŸ“¦' }}</span>
                    <span class="btn-text">{{ isInstalling ? 'å®‰è£…ä¸­...' : 'ç«‹å³å®‰è£…' }}</span>
                    <div v-if="isInstalling" class="loading-dots">
                        <span></span><span></span><span></span>
                    </div>
                </button>
                <button 
                    v-if="isInstalled && !checkingStatus" 
                    @click="checkInstallStatus" 
                    class="refresh-btn"
                    title="æ£€æŸ¥æ›´æ–°"
                >
                    ğŸ”„
                </button>
            </div>
        </div>
    </div>
</div>

<div class="editor-container" :class="{ 'disabled': !isInstalled }">
    <!-- æœªå®‰è£…é®ç½© -->
    <div v-if="!isInstalled" class="install-overlay">
        <div class="overlay-content">
            <div class="overlay-icon">ğŸ¤–</div>
            <h3>éœ€è¦å®‰è£…AIç³»ç»Ÿ</h3>
            <p>è¡Œä¸ºæ ‘ç¼–è¾‘å™¨éœ€è¦å®‰è£…AIç³»ç»Ÿæ‰èƒ½æ­£å¸¸ä½¿ç”¨</p>
            <div class="overlay-actions">
                <button 
                    @click="handleInstall" 
                    :disabled="isInstalling"
                    class="overlay-install-btn"
                    :class="{ 'installing': isInstalling }"
                >
                    <span>{{ isInstalling ? 'â³ å®‰è£…ä¸­...' : 'ğŸ“¦ ç«‹å³å®‰è£…AIç³»ç»Ÿ' }}</span>
                    <div v-if="isInstalling" class="loading-spinner"></div>
                </button>
            </div>
            <div class="overlay-note">
                <small>ğŸ“ å®‰è£…å®Œæˆåç¼–è¾‘å™¨å°†è‡ªåŠ¨å¯ç”¨</small>
            </div>
        </div>
    </div>
    <!-- å·¦ä¾§èŠ‚ç‚¹é¢æ¿ -->
    <div class="nodes-panel">
        <div class="panel-header">
            <h3>ğŸ“¦ èŠ‚ç‚¹åº“</h3>
            <input 
                type="text" 
                v-model="nodeSearchText" 
                placeholder="æœç´¢èŠ‚ç‚¹..." 
                class="search-input"
            >
        </div>
        
        <div class="node-categories">
            <!-- æ ¹èŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸŒ³ æ ¹èŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredRootNodes()" 
                        :key="node.type"
                        class="node-item root"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- å¤åˆèŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸ”— å¤åˆèŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredCompositeNodes()" 
                        :key="node.type"
                        class="node-item composite"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- è£…é¥°å™¨èŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸ­ è£…é¥°å™¨</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredDecoratorNodes()" 
                        :key="node.type"
                        class="node-item decorator"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- åŠ¨ä½œèŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">âš¡ åŠ¨ä½œèŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredActionNodes()" 
                        :key="node.type"
                        class="node-item action"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- æ¡ä»¶èŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">â“ æ¡ä»¶èŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredConditionNodes()" 
                        :key="node.type"
                        class="node-item condition"
                        :class="{ 'draggable-condition': node.isDraggableCondition }"
                        :draggable="true"
                        @dragstart="handleConditionNodeDragStart($event, node)"
                        :title="node.description + (node.isDraggableCondition ? ' (å¯æ‹–æ‹½åˆ°æ¡ä»¶è£…é¥°å™¨)' : '')"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                        <span v-if="node.isDraggableCondition" class="drag-hint">ğŸ¯</span>
                    </div>
                </div>
            </div>

            <!-- ECSèŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸ® ECSèŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredECSNodes()" 
                        :key="node.type"
                        class="node-item ecs"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <div class="zoom-controls">
                <button @click="zoomIn">ğŸ”+</button>
                <span>{{ Math.round(zoomLevel * 100) }}%</span>
                <button @click="zoomOut">ğŸ”-</button>
                <button @click="resetZoom">é‡ç½®</button>
            </div>
            <div class="canvas-actions">
                <button @click="centerView">å±…ä¸­</button>
                <button @click="autoLayout">è‡ªåŠ¨å¸ƒå±€</button>
                <button @click="validateTree">éªŒè¯</button>
                <button @click="clearAllConnections" title="æ¸…é™¤æ‰€æœ‰è¿æ¥çº¿" v-if="connections.length > 0">æ¸…é™¤è¿çº¿</button>
            </div>
        </div>
        
        <div 
            ref="canvasAreaRef"
            class="canvas-area"
            :class="{ 
                'connecting': dragState.isConnecting,
                'condition-dragging': conditionDragState.isDraggingCondition 
            }"
            @drop="handleCanvasDrop"
            @dragover="onCanvasDragOver"
            @wheel="onCanvasWheel"
            @mousedown="onCanvasMouseDown"
            @mousemove="onCanvasMouseMove"
            @mouseup="onCanvasMouseUp"
        >
            <canvas 
                :width="canvasWidth" 
                :height="canvasHeight"
                class="behavior-tree-canvas"
            ></canvas>
            
            <!-- è¿æ¥çº¿ç»˜åˆ¶å±‚ -->
            <svg 
                ref="svgRef"
                class="connection-layer" 
                :width="canvasWidth" 
                :height="canvasHeight"
            >
                <g :transform="'translate(' + panX + ', ' + panY + ') scale(' + zoomLevel + ')'">
                    <path 
                        v-for="connection in connections" 
                        :key="connection.id"
                        :d="connection.path"
                        class="connection-line"
                        :class="{ 'connection-active': connection.active }"
                        @click="onConnectionClick($event, connection.id)"
                        :title="'ç‚¹å‡»åˆ é™¤è¿æ¥çº¿ (' + connection.sourceId + ' â†’ ' + connection.targetId + ')'"
                    />
                    <!-- ä¸´æ—¶è¿æ¥çº¿ -->
                    <path 
                        v-if="connectionState.tempPath"
                        :d="connectionState.tempPath"
                        class="connection-temp"
                    />
                </g>
            </svg>
            
            <!-- èŠ‚ç‚¹æ¸²æŸ“å±‚ -->
            <div 
                class="nodes-layer" 
                :style="{ transform: 'translate(' + panX + 'px, ' + panY + 'px) scale(' + zoomLevel + ')' }"
            >
                <div 
                    v-for="node in treeNodes" 
                    :key="node.id"
                    :data-node-id="node.id"
                    class="tree-node"
                    :class="[
                        'node-' + node.type, 
                        { 
                            'node-selected': selectedNodeId === node.id,
                            'node-error': node.hasError,
                            'dragging': dragState.dragNode && dragState.dragNode.id === node.id,
                            'condition-hover': conditionDragState.hoveredDecoratorId === node.id,
                            'can-accept-condition': canAcceptCondition(node) && conditionDragState.isDraggingCondition
                        }
                    ]"
                    :style="{ 
                        left: node.x + 'px', 
                        top: node.y + 'px' 
                    }"
                    @click="selectNode(node.id)"
                    @mousedown="startNodeDrag($event, node)"
                    @drop="handleNodeDrop($event, node)"
                    @dragover="handleNodeDragOver($event, node)"
                    @dragleave="handleNodeDragLeave($event, node)"
                >
                    <div class="node-header">
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-title">{{ node.name }}</span>
                        <button class="node-delete" @click.stop="deleteNode(node.id)">Ã—</button>
                    </div>
                    <div class="node-body">
                        <div v-if="node.description" class="node-description">{{ node.description }}</div>
                        
                        <!-- æ¡ä»¶è£…é¥°å™¨çš„æ¡ä»¶æ˜¾ç¤º -->
                        <div v-if="node.type === 'conditional-decorator'" class="condition-attachment-area">
                            <div v-if="node.attachedCondition" class="attached-condition">
                                <div 
                                    class="condition-info"
                                    :class="{ 'condition-selected': selectedConditionNodeId === node.id }"
                                    @click.stop="selectConditionNode(node)"
                                    title="ç‚¹å‡»ç¼–è¾‘æ¡ä»¶å±æ€§"
                                >
                                    <span class="condition-icon">{{ node.attachedCondition.icon }}</span>
                                    <span class="condition-text">{{ getConditionDisplayText(node) }}</span>
                                    <span class="edit-hint">ğŸ“</span>
                                </div>
                                <button 
                                    class="remove-condition-btn" 
                                    @click.stop="removeConditionFromDecorator(node)"
                                    title="ç§»é™¤æ¡ä»¶"
                                >Ã—</button>
                            </div>
                            <div v-else class="condition-placeholder">
                                <span class="placeholder-text">ğŸ¯ æ‹–æ‹½æ¡ä»¶åˆ°æ­¤å¤„</span>
                            </div>
                        </div>
                        
                        <!-- èŠ‚ç‚¹å±æ€§é¢„è§ˆ -->
                        <div v-if="hasVisibleProperties(node)" class="node-properties-preview">
                            <div 
                                v-for="(prop, key) in getVisibleProperties(node)" 
                                :key="key"
                                class="property-preview-item"
                                :title="prop.name + ': ' + prop.description"
                            >
                                <span class="property-label">{{ prop.name }}:</span>
                                <span class="property-value" :class="'property-' + prop.type">
                                    {{ formatPropertyValue(prop) }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥ç«¯å£ -->
                    <div 
                        v-if="node.canHaveParent"
                        class="port port-input"
                        :class="{ 
                            'connecting': connectionState.isConnecting && 
                                         connectionState.startPortType === 'output' && 
                                         connectionState.startNodeId !== node.id,
                            'drag-target': isValidConnectionTarget(node.id, 'input')
                        }"
                        @mousedown.stop="startConnection($event, node.id, 'input')"
                        @mouseenter="onPortHover(node.id, 'input')"
                        @mouseleave="onPortLeave()"
                        title="æ‰§è¡Œæµå…¥å£"
                    >
                        <div class="port-inner"></div>
                    </div>
                    
                    <!-- è¾“å‡ºç«¯å£ -->
                    <div 
                        v-if="node.canHaveChildren"
                        class="port port-output"
                        :class="{ 
                            'connecting': connectionState.isConnecting && 
                                         connectionState.startPortType === 'input' && 
                                         connectionState.startNodeId !== node.id,
                            'drag-target': isValidConnectionTarget(node.id, 'output')
                        }"
                        @mousedown.stop="startConnection($event, node.id, 'output')"
                        @mouseenter="onPortHover(node.id, 'output')"
                        @mouseleave="onPortLeave()"
                        title="æ‰§è¡Œæµå‡ºå£"
                    >
                        <div class="port-inner"></div>
                    </div>

                    <div v-if="node.children && node.children.length > 0" class="children-indicator">
                        {{ node.children.length }}
                    </div>
                </div>
            </div>
            

            <div class="grid-background" :style="gridStyle()"></div>
        </div>
    </div>


    <div class="properties-panel-container">

        <div class="properties-panel">
            <div class="panel-header">
                <h3>âš™ï¸ å±æ€§é¢æ¿</h3>
            </div>
            
            <div v-if="activeNode" class="node-properties">
                <div class="property-section">
                    <h4>åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="property-item">
                        <label>èŠ‚ç‚¹åç§°:</label>
                        <input 
                            type="text" 
                            :value="activeNode.name" 
                            @input="updateNodeProperty('name', $event.target.value)"
                            :key="activeNode.id + '_name'"
                            :disabled="activeNode.isConditionNode"
                        >
                    </div>
                    <div class="property-item">
                        <label>æè¿°:</label>
                        <textarea 
                            :value="activeNode.description"
                            @input="updateNodeProperty('description', $event.target.value)"
                            :key="activeNode.id + '_description'"
                            :disabled="activeNode.isConditionNode"
                        ></textarea>
                    </div>
                </div>

                <div class="property-section" v-if="activeNode.properties">
                    <h4>èŠ‚ç‚¹å±æ€§</h4>
                    <div 
                        v-for="(prop, key) in activeNode.properties" 
                        :key="key"
                        class="property-item"
                        :class="{ 'blackboard-droppable': isBlackboardDroppable(prop) }"
                        @drop="handleBlackboardDrop($event, key)"
                        @dragover="handleBlackboardDragOver"
                        @dragleave="handleBlackboardDragLeave"
                    >
                        <label>{{ prop.name }}:</label>
                        <div class="property-input-container">
                            <input 
                                v-if="prop.type === 'string'"
                                type="text" 
                                :value="prop.value"
                                @input="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                                :key="activeNode.id + '_' + key + '_string'"
                                :placeholder="'æ‹–æ‹½Blackboardå˜é‡æˆ–ç›´æ¥è¾“å…¥'"
                            >
                            <input 
                                v-else-if="prop.type === 'number'"
                                type="number" 
                                :value="prop.value"
                                @input="updateNodeProperty('properties.' + key + '.value', parseFloat($event.target.value) || 0)"
                                :key="activeNode.id + '_' + key + '_number'"
                                :placeholder="'æ‹–æ‹½Blackboardå˜é‡æˆ–ç›´æ¥è¾“å…¥'"
                            >
                            <input 
                                v-else-if="prop.type === 'boolean'"
                                type="checkbox" 
                                :checked="prop.value"
                                @change="updateNodeProperty('properties.' + key + '.value', $event.target.checked)"
                                :key="activeNode.id + '_' + key + '_boolean'"
                            >
                            <textarea 
                                v-else-if="prop.type === 'code'"
                                :value="prop.value"
                                @input="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                                rows="6"
                                class="code-input"
                                placeholder="è¯·è¾“å…¥ä»£ç ..."
                                :key="activeNode.id + '_' + key + '_code'"
                            ></textarea>
                            <select 
                                v-else-if="prop.type === 'select'"
                                :value="prop.value"
                                @change="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                                :key="activeNode.id + '_' + key + '_select_' + prop.value"
                            >
                                <option 
                                    v-for="option in prop.options" 
                                    :key="option" 
                                    :value="option"
                                    :selected="option === prop.value"
                                >
                                    {{ option }}
                                </option>
                            </select>
                            
                            <div v-if="isBlackboardReference(prop.value)" class="blackboard-reference">
                                <span class="ref-icon">ğŸ”—</span>
                                <span class="ref-text">{{ prop.value }}</span>
                                <button class="clear-ref" @click="clearBlackboardReference(key)" title="æ¸…é™¤å¼•ç”¨">Ã—</button>
                            </div>
                        </div>
                        <p v-if="prop.description" class="property-help">{{ prop.description }}</p>
                    </div>
                </div>

                <div class="property-section">
                    <h4>èŠ‚ç‚¹é…ç½®</h4>
                    <pre class="config-preview">{{ activeNode ? JSON.stringify(activeNode, null, 2) : '{}' }}</pre>
                </div>
            </div>
            
            <div v-else class="no-selection">
                <p>è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>
            </div>
        </div>
    </div>
</div>


<div class="tree-structure-panel" v-if="rootNode()">
    <div class="panel-header">
        <h3>ğŸŒ² æ ‘ç»“æ„</h3>
    </div>
    <div class="tree-view">
        <tree-node-item 
            :node="rootNode()"
            :level="0"
            :get-node-by-id-local="getNodeByIdLocal"
            @node-select="selectNode"
        ></tree-node-item>
    </div>
</div>


<div v-if="!validationResult().isValid" class="validation-error">
    <span class="error-icon">âš ï¸</span>
    <span>{{ validationResult().message }}</span>
</div>


<div v-if="showBlackboardModal" class="modal-overlay" @click="showBlackboardModal = false">
    <div class="modal-content blackboard-modal" @click.stop>
        <div class="modal-header">
            <h3>{{ editingBlackboardVariable ? 'ç¼–è¾‘å˜é‡' : 'æ·»åŠ å˜é‡' }}</h3>
            <button @click="showBlackboardModal = false">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>å˜é‡åç§°:</label>
                <input 
                    type="text" 
                    v-model="blackboardModalData.name" 
                    placeholder="ä¾‹å¦‚ï¼šplayerHealthã€enemyCount..."
                    :disabled="editingBlackboardVariable"
                    class="form-input"
                >
            </div>
            
            <div class="form-group">
                <label>å˜é‡ç±»å‹:</label>
                <select v-model="blackboardModalData.type" class="form-select">
                    <option value="string">ğŸ“ å­—ç¬¦ä¸² (string)</option>
                    <option value="number">ğŸ”¢ æ•°å­— (number)</option>
                    <option value="boolean">â˜‘ï¸ å¸ƒå°”å€¼ (boolean)</option>
                    <option value="vector2">ğŸ“ äºŒç»´å‘é‡ (vector2)</option>
                    <option value="vector3">ğŸ“ ä¸‰ç»´å‘é‡ (vector3)</option>
                    <option value="object">ğŸ“¦ å¯¹è±¡ (object)</option>
                    <option value="array">ğŸ“‹ æ•°ç»„ (array)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>é»˜è®¤å€¼:</label>
                <input 
                    v-if="blackboardModalData.type === 'string'"
                    type="text" 
                    v-model="blackboardModalData.defaultValue" 
                    placeholder="è¾“å…¥é»˜è®¤å­—ç¬¦ä¸²å€¼..."
                    class="form-input"
                >
                <input 
                    v-else-if="blackboardModalData.type === 'number'"
                    type="number" 
                    v-model="blackboardModalData.defaultValue" 
                    placeholder="è¾“å…¥é»˜è®¤æ•°å€¼..."
                    class="form-input"
                >
                <div v-else-if="blackboardModalData.type === 'boolean'" class="checkbox-group">
                    <input 
                        type="checkbox" 
                        v-model="blackboardModalData.defaultValue"
                        id="defaultBoolValue"
                    >
                    <label for="defaultBoolValue">é»˜è®¤ä¸º True</label>
                </div>
                <textarea 
                    v-else
                    v-model="blackboardModalData.defaultValue" 
                    placeholder="è¯·è¾“å…¥JSONæ ¼å¼çš„é»˜è®¤å€¼ï¼Œä¾‹å¦‚ï¼š{&quot;x&quot;: 0, &quot;y&quot;: 0}"
                    rows="3"
                    class="form-textarea"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label>æè¿°:</label>
                <textarea 
                    v-model="blackboardModalData.description" 
                    placeholder="æè¿°è¿™ä¸ªå˜é‡çš„ç”¨é€”å’Œä½œç”¨..."
                    rows="2"
                    class="form-textarea"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label>åˆ†ç»„:</label>
                <input 
                    type="text" 
                    v-model="blackboardModalData.group" 
                    placeholder="ä¾‹å¦‚ï¼šPlayerã€AIã€Environmentã€Game..."
                    class="form-input"
                >
            </div>
            
            <div v-if="blackboardModalData.type === 'number'" class="form-group">
                <label>æ•°å€¼çº¦æŸ:</label>
                <div class="constraint-inputs">
                    <div class="constraint-row">
                        <label>æœ€å°å€¼:</label>
                        <input type="number" v-model="blackboardModalData.constraints.min" placeholder="ä¸é™åˆ¶" class="form-input">
                    </div>
                    <div class="constraint-row">
                        <label>æœ€å¤§å€¼:</label>
                        <input type="number" v-model="blackboardModalData.constraints.max" placeholder="ä¸é™åˆ¶" class="form-input">
                    </div>
                    <div class="constraint-row">
                        <label>æ­¥é•¿:</label>
                        <input type="number" v-model="blackboardModalData.constraints.step" placeholder="1" class="form-input">
                    </div>
                </div>
            </div>
            
            <div v-if="blackboardModalData.type === 'string'" class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" v-model="blackboardModalData.useAllowedValues" id="useAllowedValues">
                    <label for="useAllowedValues">é™åˆ¶å¯é€‰å€¼</label>
                </div>
                <div v-if="blackboardModalData.useAllowedValues" class="allowed-values">
                    <textarea 
                        v-model="blackboardModalData.allowedValuesText" 
                        placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªå¯é€‰å€¼&#10;ä¾‹å¦‚ï¼š&#10;idle&#10;running&#10;jumping&#10;attacking"
                        rows="4"
                        class="form-textarea"
                    ></textarea>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" v-model="blackboardModalData.readOnly" id="readOnlyVar">
                <label for="readOnlyVar">åªè¯»å˜é‡</label>
            </div>
        </div>
        <div class="modal-footer">
            <button @click="saveBlackboardVariable" class="save-btn">ä¿å­˜</button>
            <button @click="showBlackboardModal = false" class="cancel-btn">å–æ¶ˆ</button>
        </div>
    </div>
</div>


<div class="blackboard-sidebar" 
     :class="{ 
         'collapsed': blackboardCollapsed, 
         'transparent': blackboardTransparent 
     }"
     @mouseenter="blackboardTransparent = false"
     @mouseleave="blackboardTransparent = true">
    
    <button class="blackboard-toggle" 
            @click="blackboardCollapsed = !blackboardCollapsed"
            :title="blackboardCollapsed ? 'å±•å¼€ Blackboard' : 'æ”¶ç¼© Blackboard'">
        <span v-if="blackboardCollapsed">ğŸ“‹</span>
        <span v-else>â—€</span>
    </button>
    
    <div class="blackboard-content" v-show="!blackboardCollapsed">
        <div class="blackboard-header">
            <h3>ğŸ“‹ Blackboard</h3>
        </div>
        
        <div class="blackboard-actions">
            <button @click="showBlackboardModal = true" class="add-var-btn">+ æ·»åŠ å˜é‡</button>
            <button @click="clearBlackboard" v-if="blackboardVariables.length > 0" class="clear-btn">æ¸…ç©º</button>
        </div>
        
        <div class="blackboard-scroll-area">
            <div v-if="blackboardVariables.length > 0" class="blackboard-groups">
                <div 
                    v-for="[groupName, variables] in groupedBlackboardVariables()" 
                    :key="groupName" 
                    class="variable-group"
                >
                    <h4 class="group-title">{{ groupName }}</h4>
                    <div class="variable-list">
                        <div 
                            v-for="variable in variables" 
                            :key="variable.name"
                            class="variable-item"
                            :class="variable.type"
                            :draggable="true"
                            @dragstart="onBlackboardDragStart($event, variable)"
                            :title="variable.description"
                        >
                            <div class="variable-header">
                                <span class="variable-name">{{ variable.name }}</span>
                                <span class="variable-type">{{ getTypeDisplayName(variable.type) }}</span>
                                <div class="variable-actions">
                                    <button @click="editBlackboardVariable(variable)" class="edit-btn">âœï¸</button>
                                    <button @click="removeBlackboardVariable(variable.name)" class="remove-btn">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            
                            <div class="variable-value">
                                <select 
                                    v-if="variable.constraints && variable.constraints.allowedValues" 
                                    v-model="variable.value"
                                    @change="onBlackboardValueChange(variable)"
                                    :disabled="variable.readOnly"
                                >
                                    <option 
                                        v-for="option in variable.constraints.allowedValues" 
                                        :key="option" 
                                        :value="option"
                                    >
                                        {{ option }}
                                    </option>
                                </select>
                                <span v-else class="value-display">{{ getDisplayValue(variable) }}</span>
                            </div>
                            
                            <div v-if="variable.constraints && hasVisibleConstraints(variable)" class="variable-constraints">
                                <small>{{ formatConstraints(variable.constraints) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                          
            <div v-else class="empty-blackboard">
                <div class="empty-icon">ğŸ“‹</div>
                <p>è¿˜æ²¡æœ‰å®šä¹‰ä»»ä½•å˜é‡</p>
                <button class="add-first-var" @click="showBlackboardModal = true">æ·»åŠ ç¬¬ä¸€ä¸ªå˜é‡</button>
            </div>
        </div>
    </div>
</div>



<div v-if="showExportModal" class="modal-overlay" @click="showExportModal = false">
    <div class="modal-content" @click.stop>
        <div class="modal-header">
            <h3>å¯¼å‡ºé…ç½®</h3>
            <button @click="showExportModal = false">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <label>
                    <input type="radio" v-model="exportFormat" value="json"> JSONé…ç½®
                </label>
                <label>
                    <input type="radio" v-model="exportFormat" value="typescript"> TypeScriptä»£ç 
                </label>
            </div>
            <textarea 
                class="export-code" 
                :value="exportedCode()" 
                readonly
            ></textarea>
        </div>
        <div class="modal-footer">
            <button @click="copyToClipboard">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            <button @click="saveToFile">ä¿å­˜åˆ°æ–‡ä»¶</button>
            <button @click="showExportModal = false">å…³é—­</button>
        </div>
    </div>
</div> 