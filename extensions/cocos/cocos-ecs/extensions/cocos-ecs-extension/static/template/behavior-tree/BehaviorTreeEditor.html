<!-- å¤´éƒ¨å·¥å…·æ  -->
<div class="header-toolbar">
    <div class="toolbar-left">
        <h2>ğŸŒ³ è¡Œä¸ºæ ‘å¯è§†åŒ–ç¼–è¾‘å™¨ 
            <span v-if="currentFileName" class="current-file">- {{ currentFileName }}</span>
            <span v-if="hasUnsavedChanges" class="unsaved-indicator">â—</span>
        </h2>
        <div class="toolbar-buttons">
            <button class="tool-btn" @click="newBehaviorTree" title="æ–°å»ºè¡Œä¸ºæ ‘">
                <span>ğŸ“„</span> æ–°å»º
            </button>
            <button class="tool-btn" :class="{ 'has-changes': hasUnsavedChanges }" @click="saveBehaviorTree" :title="currentFilePath ? 'ä¿å­˜åˆ°: ' + currentFilePath : (currentFileName ? 'å¦å­˜ä¸º ' + currentFileName : 'ä¿å­˜è¡Œä¸ºæ ‘')">
                <span>ğŸ’¾</span> ä¿å­˜{{ hasUnsavedChanges ? ' *' : '' }}
            </button>
            <button class="tool-btn" @click="saveAsBehaviorTree" title="å¦å­˜ä¸ºæ–°æ–‡ä»¶">
                <span>ğŸ’¾</span> å¦å­˜ä¸º
            </button>
            <button class="tool-btn" @click="loadBehaviorTree" title="åŠ è½½è¡Œä¸ºæ ‘">
                <span>ğŸ“‚</span> åŠ è½½
            </button>
            <button class="tool-btn" @click="exportConfig" title="å¯¼å‡ºé…ç½®">
                <span>âš¡</span> å¯¼å‡ºé…ç½®
            </button>
        </div>
    </div>
    <div class="toolbar-right">
        <div class="install-status" :class="installStatusClass()">
            <span>{{ installStatusText() }}</span>
            <button v-if="!isInstalled" @click="handleInstall" :disabled="isInstalling">
                {{ isInstalling ? 'å®‰è£…ä¸­...' : 'å®‰è£…AIç³»ç»Ÿ' }}
            </button>
        </div>
    </div>
</div>

<div class="editor-container">
    <!-- å·¦ä¾§èŠ‚ç‚¹é¢æ¿ -->
    <div class="nodes-panel">
        <div class="panel-header">
            <h3>ğŸ“¦ èŠ‚ç‚¹åº“</h3>
            <input 
                type="text" 
                v-model="nodeSearchText" 
                placeholder="æœç´¢èŠ‚ç‚¹..." 
                class="search-input"
            >
        </div>
        
        <div class="node-categories">
            <!-- å¤åˆèŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸ”— å¤åˆèŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredCompositeNodes()" 
                        :key="node.type"
                        class="node-item composite"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- è£…é¥°å™¨èŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸ­ è£…é¥°å™¨</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredDecoratorNodes()" 
                        :key="node.type"
                        class="node-item decorator"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- åŠ¨ä½œèŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">âš¡ åŠ¨ä½œèŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredActionNodes()" 
                        :key="node.type"
                        class="node-item action"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- æ¡ä»¶èŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">â“ æ¡ä»¶èŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredConditionNodes()" 
                        :key="node.type"
                        class="node-item condition"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>

            <!-- ECSèŠ‚ç‚¹ -->
            <div class="category">
                <h4 class="category-title">ğŸ® ECSèŠ‚ç‚¹</h4>
                <div class="node-list">
                    <div 
                        v-for="node in filteredECSNodes()" 
                        :key="node.type"
                        class="node-item ecs"
                        :draggable="true"
                        @dragstart="onNodeDragStart($event, node)"
                        :title="node.description"
                    >
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-name">{{ node.name }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <div class="zoom-controls">
                <button @click="zoomIn">ğŸ”+</button>
                <span>{{ Math.round(zoomLevel * 100) }}%</span>
                <button @click="zoomOut">ğŸ”-</button>
                <button @click="resetZoom">é‡ç½®</button>
            </div>
            <div class="canvas-actions">
                <button @click="centerView">å±…ä¸­</button>
                <button @click="autoLayout">è‡ªåŠ¨å¸ƒå±€</button>
                <button @click="validateTree">éªŒè¯</button>
            </div>
        </div>
        
        <div 
            ref="canvasAreaRef"
            class="canvas-area"
            :class="{ 'connecting': dragState.isConnecting }"
            @drop="onCanvasDrop"
            @dragover="onCanvasDragOver"
            @wheel="onCanvasWheel"
            @mousedown="onCanvasMouseDown"
            @mousemove="onCanvasMouseMove"
            @mouseup="onCanvasMouseUp"
        >
            <canvas 
                :width="canvasWidth" 
                :height="canvasHeight"
                class="behavior-tree-canvas"
            ></canvas>
            
            <!-- è¿æ¥çº¿ç»˜åˆ¶å±‚ -->
            <svg 
                ref="svgRef"
                class="connection-layer" 
                :width="canvasWidth" 
                :height="canvasHeight"
            >
                <g :transform="'translate(' + panX + ', ' + panY + ') scale(' + zoomLevel + ')'">
                    <path 
                        v-for="connection in connections" 
                        :key="connection.id"
                        :d="connection.path"
                        class="connection-line"
                        :class="{ 'connection-active': connection.active }"
                    />
                    <!-- ä¸´æ—¶è¿æ¥çº¿ -->
                    <path 
                        v-if="connectionState.tempPath"
                        :d="connectionState.tempPath"
                        class="connection-temp"
                    />
                </g>
            </svg>
            
            <!-- èŠ‚ç‚¹æ¸²æŸ“å±‚ -->
            <div 
                class="nodes-layer" 
                :style="{ transform: 'translate(' + panX + 'px, ' + panY + 'px) scale(' + zoomLevel + ')' }"
            >
                <div 
                    v-for="node in treeNodes" 
                    :key="node.id"
                    :data-node-id="node.id"
                    class="tree-node"
                    :class="[
                        'node-' + node.type, 
                        { 
                            'node-selected': selectedNodeId === node.id,
                            'node-error': node.hasError,
                            'dragging': dragState.dragNode && dragState.dragNode.id === node.id
                        }
                    ]"
                    :style="{ 
                        left: node.x + 'px', 
                        top: node.y + 'px' 
                    }"
                    @click="selectNode(node.id)"
                    @mousedown="startNodeDrag($event, node)"
                >
                    <div class="node-header">
                        <span class="node-icon">{{ node.icon }}</span>
                        <span class="node-title">{{ node.name }}</span>
                        <button class="node-delete" @click.stop="deleteNode(node.id)">Ã—</button>
                    </div>
                    <div class="node-body">
                        <div v-if="node.description" class="node-description">{{ node.description }}</div>
                        <!-- èŠ‚ç‚¹å±æ€§é¢„è§ˆ -->
                        <div v-if="hasVisibleProperties(node)" class="node-properties-preview">
                            <div 
                                v-for="(prop, key) in getVisibleProperties(node)" 
                                :key="key"
                                class="property-preview-item"
                                :title="prop.name + ': ' + prop.description"
                            >
                                <span class="property-label">{{ prop.name }}:</span>
                                <span class="property-value" :class="'property-' + prop.type">
                                    {{ formatPropertyValue(prop) }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- è¾“å…¥ç«¯å£ - æ‰§è¡Œæµå…¥å£ -->
                    <div 
                        v-if="node.canHaveParent"
                        class="port port-input"
                        :class="{ 
                            'connecting': connectionState.isConnecting && 
                                         connectionState.startPortType === 'output' && 
                                         connectionState.startNodeId !== node.id,
                            'drag-target': isValidConnectionTarget(node.id, 'input')
                        }"
                        @mousedown.stop="startConnection($event, node.id, 'input')"
                        @mouseenter="onPortHover(node.id, 'input')"
                        @mouseleave="onPortLeave()"
                        title="æ‰§è¡Œæµå…¥å£ï¼ˆå¯ä»æ­¤å¼€å§‹è¿æ¥ï¼‰"
                    >
                        <div class="port-inner"></div>
                    </div>
                    
                    <!-- è¾“å‡ºç«¯å£ - æ‰§è¡Œæµå‡ºå£ -->
                    <div 
                        v-if="node.canHaveChildren"
                        class="port port-output"
                        :class="{ 
                            'connecting': connectionState.isConnecting && 
                                         connectionState.startPortType === 'input' && 
                                         connectionState.startNodeId !== node.id,
                            'drag-target': isValidConnectionTarget(node.id, 'output')
                        }"
                        @mousedown.stop="startConnection($event, node.id, 'output')"
                        @mouseenter="onPortHover(node.id, 'output')"
                        @mouseleave="onPortLeave()"
                        title="æ‰§è¡Œæµå‡ºå£ï¼ˆå¯ä»æ­¤å¼€å§‹è¿æ¥ï¼‰"
                    >
                        <div class="port-inner"></div>
                    </div>
                    <!-- å­èŠ‚ç‚¹æŒ‡ç¤ºå™¨ -->
                    <div v-if="node.children && node.children.length > 0" class="children-indicator">
                        {{ node.children.length }}
                    </div>
                </div>
            </div>
            
            <!-- ç½‘æ ¼èƒŒæ™¯ -->
            <div class="grid-background" :style="gridStyle()"></div>
        </div>
    </div>

    <!-- å³ä¾§å±æ€§é¢æ¿ -->
    <div class="properties-panel">
        <div class="panel-header">
            <h3>âš™ï¸ å±æ€§é¢æ¿</h3>
        </div>
        
        <div v-if="selectedNode" class="node-properties">
            <div class="property-section">
                <h4>åŸºæœ¬ä¿¡æ¯</h4>
                <div class="property-item">
                    <label>èŠ‚ç‚¹åç§°:</label>
                    <input 
                        type="text" 
                        :value="selectedNode.name" 
                        @input="updateNodeProperty('name', $event.target.value)"
                        :key="selectedNode.id + '_name'"
                    >
                </div>
                <div class="property-item">
                    <label>æè¿°:</label>
                    <textarea 
                        :value="selectedNode.description"
                        @input="updateNodeProperty('description', $event.target.value)"
                        :key="selectedNode.id + '_description'"
                    ></textarea>
                </div>
            </div>

            <div class="property-section" v-if="selectedNode.properties">
                <h4>èŠ‚ç‚¹å±æ€§</h4>
                <div 
                    v-for="(prop, key) in selectedNode.properties" 
                    :key="key"
                    class="property-item"
                >
                    <label>{{ prop.name }}:</label>
                    <input 
                        v-if="prop.type === 'string'"
                        type="text" 
                        :value="prop.value"
                        @input="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                        :key="selectedNode.id + '_' + key + '_string'"
                    >
                    <input 
                        v-else-if="prop.type === 'number'"
                        type="number" 
                        :value="prop.value"
                        @input="updateNodeProperty('properties.' + key + '.value', parseFloat($event.target.value) || 0)"
                        :key="selectedNode.id + '_' + key + '_number'"
                    >
                    <input 
                        v-else-if="prop.type === 'boolean'"
                        type="checkbox" 
                        :checked="prop.value"
                        @change="updateNodeProperty('properties.' + key + '.value', $event.target.checked)"
                        :key="selectedNode.id + '_' + key + '_boolean'"
                    >
                    <textarea 
                        v-else-if="prop.type === 'code'"
                        :value="prop.value"
                        @input="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                        rows="6"
                        class="code-input"
                        placeholder="è¯·è¾“å…¥ä»£ç ..."
                        :key="selectedNode.id + '_' + key + '_code'"
                    ></textarea>
                    <select 
                        v-else-if="prop.type === 'select'"
                        :value="prop.value"
                        @change="updateNodeProperty('properties.' + key + '.value', $event.target.value)"
                        :key="selectedNode.id + '_' + key + '_select_' + prop.value"
                    >
                        <option 
                            v-for="option in prop.options" 
                            :key="option" 
                            :value="option"
                            :selected="option === prop.value"
                        >
                            {{ option }}
                        </option>
                    </select>
                    <p v-if="prop.description" class="property-help">{{ prop.description }}</p>
                </div>
            </div>

            <div class="property-section">
                <h4>èŠ‚ç‚¹é…ç½®</h4>
                <pre class="config-preview">{{ selectedNode ? JSON.stringify(selectedNode, null, 2) : '{}' }}</pre>
            </div>
        </div>
        
        <div v-else class="no-selection">
            <p>è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æŸ¥çœ‹å±æ€§</p>
        </div>
    </div>
</div>

<!-- è¡Œä¸ºæ ‘ç»“æ„é¢æ¿ -->
<div class="tree-structure-panel" v-if="rootNode()">
    <div class="panel-header">
        <h3>ğŸŒ² æ ‘ç»“æ„</h3>
    </div>
    <div class="tree-view">
        <tree-node-item 
            :node="rootNode()"
            :level="0"
            :get-node-by-id-local="getNodeByIdLocal"
            @node-select="selectNode"
        ></tree-node-item>
    </div>
</div>

<!-- éªŒè¯ç»“æœ -->
<div v-if="!validationResult().isValid" class="validation-error">
    <span class="error-icon">âš ï¸</span>
    <span>{{ validationResult().message }}</span>
</div>

<!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
<div v-if="showExportModal" class="modal-overlay" @click="showExportModal = false">
    <div class="modal-content" @click.stop>
        <div class="modal-header">
            <h3>å¯¼å‡ºé…ç½®</h3>
            <button @click="showExportModal = false">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <label>
                    <input type="radio" v-model="exportFormat" value="json"> JSONé…ç½®
                </label>
                <label>
                    <input type="radio" v-model="exportFormat" value="typescript"> TypeScriptä»£ç 
                </label>
            </div>
            <textarea 
                class="export-code" 
                :value="exportedCode()" 
                readonly
            ></textarea>
        </div>
        <div class="modal-footer">
            <button @click="copyToClipboard">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            <button @click="saveToFile">ä¿å­˜åˆ°æ–‡ä»¶</button>
            <button @click="showExportModal = false">å…³é—­</button>
        </div>
    </div>
</div> 