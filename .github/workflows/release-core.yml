name: Release Core Package

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      custom_version:
        description: 'Custom version (optional, overrides version_type)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          cd packages/core
          npm run test:ci

      - name: Determine version
        id: version
        run: |
          cd packages/core
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            echo "Using custom version: $NEW_VERSION"
          else
            # ä½¿ç”¨ npm version å‘½ä»¤è®¡ç®—æ–°ç‰ˆæœ¬ï¼ˆä½†ä¸å®žé™…æäº¤ï¼‰
            npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "Bumping ${{ github.event.inputs.version_type }} version: $CURRENT_VERSION â†’ $NEW_VERSION"
            # æ¢å¤ package.json ä»¥ä¾¿åŽç»­æ­¥éª¤é‡æ–°ä¿®æ”¹
            git checkout package.json
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package version
        run: |
          cd packages/core
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version

      - name: Build package
        run: |
          cd packages/core
          npm run build:npm

      - name: Publish to npm
        run: |
          cd packages/core/dist
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create Git tag
        run: |
          git tag -a "core-v${{ steps.version.outputs.new_version }}" -m "Release @esengine/ecs-framework v${{ steps.version.outputs.new_version }}"
          git push origin "core-v${{ steps.version.outputs.new_version }}"

  # å‘å¸ƒæˆåŠŸåŽï¼Œåˆ›å»º PR æ›´æ–°ç‰ˆæœ¬å·
  update-version-pr:
    needs: release
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Install dependencies
        run: npm ci

      - name: Generate changelog
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªcoreç‰ˆæœ¬çš„tag
          PREVIOUS_TAG=$(git tag -l "core-v*" --sort=-v:refname | head -n 1)

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating changelog from $PREVIOUS_TAG to HEAD"

          # ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼ˆåªåŒ…å«coreç›¸å…³çš„æäº¤ï¼‰
          CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges -- packages/core/)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No changes to core package since last release"
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶ä»¥ä¾¿åœ¨PRä¸­ä½¿ç”¨
          echo "$CHANGELOG" > /tmp/changelog.txt

          # è¾“å‡ºç”¨äºŽè°ƒè¯•
          echo "Changelog:"
          cat /tmp/changelog.txt

      - name: Update version in package.json
        run: |
          cd packages/core

          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          else
            npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")
          fi

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

          # éªŒè¯æ–‡ä»¶å·²ä¿®æ”¹
          git diff --exit-code package.json && echo "::error::No version change detected" && exit 1 || true

          echo "Updated package.json to version: $NEW_VERSION"
          cat package.json | grep version

      - name: Prepare PR body
        id: pr_body
        run: |
          CHANGELOG_CONTENT=$(cat /tmp/changelog.txt)

          # åˆ›å»ºPRæè¿°
          cat > /tmp/pr_body.md <<EOF
          ## ðŸš€ å‘å¸ƒ @esengine/ecs-framework v${{ env.NEW_VERSION }} / Release @esengine/ecs-framework v${{ env.NEW_VERSION }}

          **ä¸­æ–‡è¯´æ˜Ž**

          æ­¤ PR åœ¨æˆåŠŸå‘å¸ƒåˆ° npm åŽæ›´æ–°æ ¸å¿ƒåŒ…çš„ç‰ˆæœ¬å·ã€‚

          ### ðŸ“ æ›´æ–°æ—¥å¿—
          \`\`\`
          ${CHANGELOG_CONTENT}
          \`\`\`

          ### å˜æ›´å†…å®¹
          - âœ… æ›´æ–° \`packages/core/package.json\` â†’ \`${{ env.NEW_VERSION }}\`

          ### å‘å¸ƒä¿¡æ¯
          - ðŸ“¦ **ç‰ˆæœ¬ç±»åž‹**: \`${{ github.event.inputs.version_type }}\`
          - ðŸ·ï¸ **Git æ ‡ç­¾**: \`core-v${{ env.NEW_VERSION }}\`
          - ðŸ“¦ **npm åŒ…**: https://www.npmjs.com/package/@esengine/ecs-framework/v/${{ env.NEW_VERSION }}

          ### ä¸‹ä¸€æ­¥
          - [ ] å®¡æŸ¥å˜æ›´å†…å®¹
          - [ ] åˆå¹¶æ­¤ PR ä»¥æ›´æ–°ä»“åº“ä¸­çš„ç‰ˆæœ¬å·

          ---

          **English Description**

          This PR updates the core package version after successful npm release.

          ### ðŸ“ Changelog
          \`\`\`
          ${CHANGELOG_CONTENT}
          \`\`\`

          ### Changes
          - âœ… Updated \`packages/core/package.json\` â†’ \`${{ env.NEW_VERSION }}\`

          ### Release Information
          - ðŸ“¦ **Version Type**: \`${{ github.event.inputs.version_type }}\`
          - ðŸ·ï¸ **Git Tag**: \`core-v${{ env.NEW_VERSION }}\`
          - ðŸ“¦ **npm Package**: https://www.npmjs.com/package/@esengine/ecs-framework/v/${{ env.NEW_VERSION }}

          ### Next Steps
          - [ ] Review the changes
          - [ ] Merge this PR to update the version in the repository

          ---
          *æ­¤ PR ç”±å‘å¸ƒå·¥ä½œæµè‡ªåŠ¨åˆ›å»º / This PR was automatically created by the release workflow.*
          EOF

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(core): bump version to ${{ env.NEW_VERSION }}"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: release/core-v${{ env.NEW_VERSION }}
          delete-branch: true
          title: "chore(core): Release v${{ env.NEW_VERSION }}"
          body-path: /tmp/pr_body.md
          labels: |
            release
            core
            automated pr
          add-paths: |
            packages/core/package.json

      - name: Check PR creation
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
