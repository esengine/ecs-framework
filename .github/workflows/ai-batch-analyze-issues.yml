name: AI Batch Analyze Issues

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'åˆ†ææ¨¡å¼'
        required: true
        type: choice
        options:
          - 'recent' # æœ€è¿‘ 10 ä¸ª issue
          - 'open' # æ‰€æœ‰æ‰“å¼€çš„ issue
          - 'all' # æ‰€æœ‰ issueï¼ˆæ…ç”¨ï¼‰
        default: 'recent'

permissions:
  issues: write
  contents: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install GitHub CLI
        run: |
          gh --version || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh)

      - name: Batch Analyze Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODE="${{ github.event.inputs.mode }}"

          # è·å– issue åˆ—è¡¨
          if [ "$MODE" = "recent" ]; then
            echo "ğŸ“Š åˆ†ææœ€è¿‘ 10 ä¸ª issue..."
            ISSUES=$(gh issue list --limit 10 --json number --jq '.[].number')
          elif [ "$MODE" = "open" ]; then
            echo "ğŸ“Š åˆ†ææ‰€æœ‰æ‰“å¼€çš„ issue..."
            ISSUES=$(gh issue list --state open --json number --jq '.[].number')
          else
            echo "ğŸ“Š åˆ†ææ‰€æœ‰ issueï¼ˆè¿™å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰..."
            ISSUES=$(gh issue list --state all --limit 100 --json number --jq '.[].number')
          fi

          # ä¸ºæ¯ä¸ª issue æ·»åŠ  AI åˆ†æè¯„è®º
          for issue_num in $ISSUES; do
            echo "ğŸ¤– åˆ†æ Issue #$issue_num..."

            # è·å– issue å†…å®¹
            ISSUE_BODY=$(gh issue view $issue_num --json body --jq '.body')
            ISSUE_TITLE=$(gh issue view $issue_num --json title --jq '.title')

            # æ·»åŠ è§¦å‘è¯„è®º
            gh issue comment $issue_num --body "@ai-helper è¯·å¸®æˆ‘åˆ†æè¿™ä¸ª issue" || true

            # é¿å… API é™åˆ¶
            sleep 2
          done

          echo "âœ… æ‰¹é‡åˆ†æå®Œæˆï¼"
          echo "æŸ¥çœ‹ç»“æœï¼šhttps://github.com/${{ github.repository }}/issues"
