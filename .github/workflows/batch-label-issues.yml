name: Batch Label Issues

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'æ ‡ç­¾æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'recent' # æœ€è¿‘ 20 ä¸ª issue
          - 'open' # æ‰€æœ‰æ‰“å¼€çš„ issue
          - 'unlabeled' # åªå¤„ç†æ²¡æœ‰æ ‡ç­¾çš„ issue
          - 'all' # æ‰€æœ‰ issueï¼ˆæ…ç”¨ï¼‰
        default: 'recent'

      skip_labeled:
        description: 'è·³è¿‡å·²æœ‰æ ‡ç­¾çš„ issue'
        required: false
        type: boolean
        default: true

permissions:
  issues: write
  contents: read

jobs:
  batch-label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Batch Label Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MODE="${{ github.event.inputs.mode }}"
          SKIP_LABELED="${{ github.event.inputs.skip_labeled }}"

          echo "ğŸ“Š å¼€å§‹æ‰¹é‡æ‰“æ ‡ç­¾..."
          echo "æ¨¡å¼: $MODE"
          echo "è·³è¿‡å·²æ ‡ç­¾: $SKIP_LABELED"

          # è·å– issue åˆ—è¡¨
          if [ "$MODE" = "recent" ]; then
            echo "ğŸ“‹ è·å–æœ€è¿‘ 20 ä¸ª issue..."
            ISSUES=$(gh issue list --limit 20 --json number,labels,title,body --jq '.[] | {number, labels: [.labels[].name], title, body}')
          elif [ "$MODE" = "open" ]; then
            echo "ğŸ“‹ è·å–æ‰€æœ‰æ‰“å¼€çš„ issue..."
            ISSUES=$(gh issue list --state open --json number,labels,title,body --jq '.[] | {number, labels: [.labels[].name], title, body}')
          elif [ "$MODE" = "unlabeled" ]; then
            echo "ğŸ“‹ è·å–æ²¡æœ‰æ ‡ç­¾çš„ issue..."
            ISSUES=$(gh issue list --state all --json number,labels,title,body --jq '.[] | select(.labels | length == 0) | {number, labels: [.labels[].name], title, body}')
          else
            echo "ğŸ“‹ è·å–æ‰€æœ‰ issueï¼ˆé™åˆ¶ 100 ä¸ªï¼‰..."
            ISSUES=$(gh issue list --state all --limit 100 --json number,labels,title,body --jq '.[] | {number, labels: [.labels[].name], title, body}')
          fi

          # ä¸´æ—¶æ–‡ä»¶
          echo "$ISSUES" > /tmp/issues.json

          # å¤„ç†æ¯ä¸ª issue
          cat /tmp/issues.json | jq -c '.' | while read -r issue; do
            ISSUE_NUM=$(echo "$issue" | jq -r '.number')
            EXISTING_LABELS=$(echo "$issue" | jq -r '.labels | join(",")')
            TITLE=$(echo "$issue" | jq -r '.title')
            BODY=$(echo "$issue" | jq -r '.body')

            echo ""
            echo "ğŸ” å¤„ç† Issue #$ISSUE_NUM: $TITLE"
            echo "   ç°æœ‰æ ‡ç­¾: $EXISTING_LABELS"

            # è·³è¿‡å·²æœ‰æ ‡ç­¾çš„ issue
            if [ "$SKIP_LABELED" = "true" ] && [ ! -z "$EXISTING_LABELS" ]; then
              echo "   â­ï¸  è·³è¿‡ï¼ˆå·²æœ‰æ ‡ç­¾ï¼‰"
              continue
            fi

            # åˆ†æå†…å®¹å¹¶æ‰“æ ‡ç­¾
            LABELS_TO_ADD=""

            # æ£€æµ‹ bug
            if echo "$TITLE $BODY" | grep -iE "(bug|é”™è¯¯|å´©æºƒ|crash|error|exception|é—®é¢˜|fix)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD bug"
              echo "   ğŸ› æ£€æµ‹åˆ°: bug"
            fi

            # æ£€æµ‹ feature request
            if echo "$TITLE $BODY" | grep -iE "(feature|åŠŸèƒ½|enhancement|improve|ä¼˜åŒ–|å»ºè®®|æ–°å¢|æ·»åŠ |add)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD enhancement"
              echo "   âœ¨ æ£€æµ‹åˆ°: enhancement"
            fi

            # æ£€æµ‹ question
            if echo "$TITLE $BODY" | grep -iE "(question|ç–‘é—®|how to|å¦‚ä½•|æ€ä¹ˆ|ä¸ºä»€ä¹ˆ|why|å’¨è¯¢|\?|ï¼Ÿ)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD question"
              echo "   â“ æ£€æµ‹åˆ°: question"
            fi

            # æ£€æµ‹ documentation
            if echo "$TITLE $BODY" | grep -iE "(doc|æ–‡æ¡£|readme|guide|tutorial|æ•™ç¨‹|è¯´æ˜)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD documentation"
              echo "   ğŸ“– æ£€æµ‹åˆ°: documentation"
            fi

            # æ£€æµ‹ performance
            if echo "$TITLE $BODY" | grep -iE "(performance|æ€§èƒ½|slow|æ…¢|lag|å¡é¡¿|optimize|ä¼˜åŒ–)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD performance"
              echo "   âš¡ æ£€æµ‹åˆ°: performance"
            fi

            # æ£€æµ‹ core
            if echo "$TITLE $BODY" | grep -iE "(@esengine/ecs-framework|packages/core|core package|æ ¸å¿ƒåŒ…)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD core"
              echo "   ğŸ¯ æ£€æµ‹åˆ°: core"
            fi

            # æ£€æµ‹ editor
            if echo "$TITLE $BODY" | grep -iE "(editor|ç¼–è¾‘å™¨|tauri)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD editor"
              echo "   ğŸ¨ æ£€æµ‹åˆ°: editor"
            fi

            # æ£€æµ‹ network
            if echo "$TITLE $BODY" | grep -iE "(network|ç½‘ç»œ|multiplayer|å¤šäºº|åŒæ­¥)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD network"
              echo "   ğŸŒ æ£€æµ‹åˆ°: network"
            fi

            # æ£€æµ‹ help wanted
            if echo "$TITLE $BODY" | grep -iE "(help wanted|éœ€è¦å¸®åŠ©|æ±‚åŠ©)" > /dev/null; then
              LABELS_TO_ADD="$LABELS_TO_ADD help wanted"
              echo "   ğŸ†˜ æ£€æµ‹åˆ°: help wanted"
            fi

            # æ·»åŠ æ ‡ç­¾
            if [ ! -z "$LABELS_TO_ADD" ]; then
              echo "   âœ… æ·»åŠ æ ‡ç­¾: $LABELS_TO_ADD"
              for label in $LABELS_TO_ADD; do
                gh issue edit $ISSUE_NUM --add-label "$label" 2>&1 | grep -v "already exists" || true
              done
              echo "   ğŸ’¬ æ·»åŠ è¯´æ˜è¯„è®º..."
              gh issue comment $ISSUE_NUM --body "ğŸ¤– è‡ªåŠ¨æ ‡ç­¾ç³»ç»Ÿæ£€æµ‹åˆ°æ­¤ issue å¹¶æ·»åŠ äº†ç›¸å…³æ ‡ç­¾ã€‚å¦‚æœ‰è¯¯åˆ¤ï¼Œè¯·å‘ŠçŸ¥ç»´æŠ¤è€…ã€‚

ğŸ¤– Auto-labeling system detected and labeled this issue. Please let maintainers know if this is incorrect." || true
            else
              echo "   â„¹ï¸  æœªæ£€æµ‹åˆ°æ˜ç¡®ç±»å‹"
            fi

            # é¿å… API é™åˆ¶
            sleep 1
          done

          echo ""
          echo "âœ… æ‰¹é‡æ ‡ç­¾å®Œæˆï¼"
          echo "æŸ¥çœ‹ç»“æœ: https://github.com/${{ github.repository }}/issues"
