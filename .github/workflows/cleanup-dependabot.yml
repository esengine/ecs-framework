name: Cleanup Old Dependabot PRs

# æ‰‹åŠ¨è§¦å‘çš„ workflowï¼Œç”¨äºæ¸…ç†å †ç§¯çš„ Dependabot PR
on:
  workflow_dispatch:
    inputs:
      days_old:
        description: 'å…³é—­å¤šå°‘å¤©å‰åˆ›å»ºçš„ PRï¼ˆé»˜è®¤ 7 å¤©ï¼‰'
        required: false
        default: '7'
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ï¼ˆtrue=ä»…æ˜¾ç¤ºï¼Œä¸å…³é—­ï¼‰'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List and Close Old Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            const daysOld = parseInt('${{ github.event.inputs.days_old }}') || 7;
            const dryRun = '${{ github.event.inputs.dry_run }}' === 'true';
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysOld);

            console.log(`ğŸ” æŸ¥æ‰¾è¶…è¿‡ ${daysOld} å¤©çš„ Dependabot PR...`);
            console.log(`ğŸ“… æˆªæ­¢æ—¥æœŸ: ${cutoffDate.toISOString()}`);
            console.log(`ğŸƒ æ¨¡å¼: ${dryRun ? 'è¯•è¿è¡Œï¼ˆä¸ä¼šå®é™…å…³é—­ï¼‰' : 'å®é™…æ‰§è¡Œ'}`);
            console.log('---');

            // è·å–æ‰€æœ‰ Dependabot PR
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const dependabotPRs = pulls.filter(pr =>
              pr.user.login === 'dependabot[bot]' &&
              new Date(pr.created_at) < cutoffDate
            );

            console.log(`ğŸ“Š æ‰¾åˆ° ${dependabotPRs.length} ä¸ªç¬¦åˆæ¡ä»¶çš„ Dependabot PR`);
            console.log('');

            if (dependabotPRs.length === 0) {
              console.log('âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„ PR');
              return;
            }

            // æŒ‰ç±»å‹åˆ†ç»„
            const byType = {
              dev: [],
              prod: [],
              actions: [],
              other: []
            };

            for (const pr of dependabotPRs) {
              const title = pr.title.toLowerCase();
              const labels = pr.labels.map(l => l.name);

              let type = 'other';
              if (title.includes('dev-dependencies') || title.includes('development')) {
                type = 'dev';
              } else if (title.includes('production-dependencies')) {
                type = 'prod';
              } else if (labels.includes('github-actions')) {
                type = 'actions';
              }

              byType[type].push(pr);
            }

            console.log('ğŸ“‹ PR åˆ†ç±»ç»Ÿè®¡:');
            console.log(`  ğŸ”§ å¼€å‘ä¾èµ–: ${byType.dev.length} ä¸ª`);
            console.log(`  ğŸ“¦ ç”Ÿäº§ä¾èµ–: ${byType.prod.length} ä¸ª`);
            console.log(`  âš™ï¸  GitHub Actions: ${byType.actions.length} ä¸ª`);
            console.log(`  â“ å…¶ä»–: ${byType.other.length} ä¸ª`);
            console.log('');

            // å¤„ç†æ¯ä¸ª PR
            for (const pr of dependabotPRs) {
              const age = Math.floor((Date.now() - new Date(pr.created_at)) / (1000 * 60 * 60 * 24));

              console.log(`${dryRun ? 'ğŸ”' : 'ğŸ—‘ï¸ '} #${pr.number}: ${pr.title}`);
              console.log(`   åˆ›å»ºæ—¶é—´: ${pr.created_at} (${age} å¤©å‰)`);
              console.log(`   é“¾æ¥: ${pr.html_url}`);

              if (!dryRun) {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  state: 'closed'
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `ğŸ¤– **è‡ªåŠ¨å…³é—­æ—§çš„ Dependabot PR**

æ­¤ PR å·²è¶…è¿‡ ${daysOld} å¤©æœªåˆå¹¶ï¼Œå·²è¢«è‡ªåŠ¨å…³é—­ä»¥æ¸…ç†ç§¯å‹ã€‚

ğŸ“Œ **ä¸‹ä¸€æ­¥ï¼š**
- Dependabot å·²é…ç½®ä¸ºæœˆåº¦è¿è¡Œï¼Œå±Šæ—¶ä¼šåˆ›å»ºæ–°çš„åˆ†ç»„æ›´æ–°
- æ–°çš„ Mergify è§„åˆ™ä¼šæ™ºèƒ½å¤„ç†ä¸åŒç±»å‹çš„ä¾èµ–æ›´æ–°
- å¼€å‘ä¾èµ–å’Œ GitHub Actions ä¼šè‡ªåŠ¨åˆå¹¶ï¼ˆå³ä½¿ CI å¤±è´¥ï¼‰
- ç”Ÿäº§ä¾èµ–éœ€è¦ CI é€šè¿‡æ‰ä¼šè‡ªåŠ¨åˆå¹¶

å¦‚æœéœ€è¦ç«‹å³åº”ç”¨æ­¤æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°ä¾èµ–ã€‚

---
*æ­¤æ“ä½œç”±ä»“åº“ç»´æŠ¤è€…æ‰‹åŠ¨è§¦å‘çš„æ¸…ç†å·¥ä½œæµæ‰§è¡Œ*`
                });

                console.log('   âœ… å·²å…³é—­å¹¶æ·»åŠ è¯´æ˜');
              } else {
                console.log('   â„¹ï¸  è¯•è¿è¡Œæ¨¡å¼ - æœªæ‰§è¡Œæ“ä½œ');
              }
              console.log('');
            }

            console.log('---');
            if (dryRun) {
              console.log(`âœ¨ è¯•è¿è¡Œå®Œæˆï¼å…±å‘ç° ${dependabotPRs.length} ä¸ªå¾…æ¸…ç†çš„ PR`);
              console.log('ğŸ’¡ è¦å®é™…æ‰§è¡Œæ¸…ç†ï¼Œè¯·å°† dry_run å‚æ•°è®¾ä¸º false é‡æ–°è¿è¡Œ');
            } else {
              console.log(`âœ… æ¸…ç†å®Œæˆï¼å·²å…³é—­ ${dependabotPRs.length} ä¸ª Dependabot PR`);
            }
